\documentclass[nofonts, oneside]{ctexbook}

\usepackage{geometry}
\usepackage{fontspec}
\usepackage{xeCJK}
\usepackage{amssymb}
\usepackage{hyperref}
% for number of footnote
\usepackage{pifont}
% 一页结束时, 脚注编号清零
\usepackage[perpage]{footmisc}
% verbatim and endverbatim
\usepackage{graphicx}
\usepackage{listings}
\usepackage{multicol}
\usepackage{tocloft}
\usepackage{listings}
\usepackage{theorem}

% 脚注编号带圈
\renewcommand\thefootnote{\ding{\numexpr171+\value{footnote}}}

% from package geometry
% 为边注加边框
\let\oldmarginpar=\marginpar
\renewcommand\marginpar[1]{%
    \oldmarginpar{\framebox{#1}}%
}
\geometry{%
    margin=1cm,
    marginparsep = 0.5cm,
    marginparwidth=1cm,
    top = 2.5cm,
    bottom = 2cm,
    outer = 1.8cm,
    inner = 1.8cm
}

% from package hyperref
\hypersetup{
    bookmarksnumbered = true,
    pdftitle = {The UNIX Programming Environment},
    pdfcreator = {wuzhouhui250@gmail.com},
    pdfauthor = {Brian W. Kernighan, Rob Pike},
    pdfsubject = {UNIX},
    colorlinks = false,
    pdfborder = 0 0 0,
    pdfkeywords = {Operating System, UNIX}
}

\setCJKfamilyfont{heiti}{FandolHei}
\setCJKfamilyfont{kaiti}{FandolKai}
% 章节格式
\CTEXsetup[format={\CJKfamily{heiti}\large\upshape}]{subsection}
\CTEXsetup[numberformat={\CJKfamily{heiti}\large\upshape\bfseries}]{subsection}
\CTEXsetup[format={\CJKfamily{heiti}}]{subsubsection}
% 目录格式
\renewcommand\cftchapfont{\CJKfamily{heiti}}
\settowidth\cftchapnumwidth{第几十几章} % 最宽的可能编号
\renewcommand\cftchapaftersnumb{\hspace{2.2em}} % 额外间距

% 术语
\newcommand\upeterm[1]{{\raisebox{0.00em}{\CJKfamily{kaiti}{#1}}}}
% 控制字符记法
\newcommand\upectl[1]{\textit{ctl}-\texttt{#1}}

% from package fontspec and xeCJK
\setCJKmainfont{FandolSong}
\setCJKsansfont{FandolSong}
\setCJKmonofont[Scale=0.82]{AR PL UMing CN}
\setmainfont{Nimbus Roman No9 L}
\setsansfont{FreeSans}
% "Mapping={}" make quote symbol straight
\setmonofont[Mapping={}]{Courier 10 Pitch}

% shell 环境
% FIXME: 连字符过长
\lstnewenvironment{upeshell}
    {
	\lstset{
		flexiblecolumns,
		basicstyle = \ttfamily,
		xleftmargin = 2em,
		tabsize = 8,
        escapeinside = {++},
		moredelim = [is][\rmfamily\itshape]{\#}{\#},
		moredelim = [is][\slshape]{^}{^}
	}
    }
    {}

% 习题环境
% TODO: 习题编号以负号分隔, 而非点号
\theoremstyle{plain}
\theorembodyfont{\normalfont}
\newtheorem{upeexer}{习题}[chapter]

\title{UNIX 编程环境}
\author{Brian W. Kernighan
    \and Rob Pike
    \and \url{https://github.com/wuzhouhui/upe}
}
